{%- import 'syntax.sql.jinja' as syntax -%}
CREATE TABLE IF NOT EXISTS {{ table_name }} AS
WITH union_block AS (
{%- for keyword in keywords %}
SELECT
    a.rxcui,
    a.str,
    a.tty,
    a.sab,
    a.code,
    '{{ keyword }}' as keyword
FROM {{ source_table }} AS a
WHERE {{ syntax.ilike('a.str', '%'+keyword+'%' )}}
{{ syntax.union_delineate(loop) }}
{%- endfor %}
)

SELECT DISTINCT
    a.rxcui,
    a.str,
    a.tty,
    a.sab,
    a.code,
    b.keyword
FROM {{ source_table }} AS a
LEFT JOIN union_block as b
ON a.rxcui= b.rxcui
AND a.str= b.str
AND a.tty= b.tty
AND a.sab= b.sab
AND a.code= b.code


